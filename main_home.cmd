::[Bat To Exe Converter]
::
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMB9ZbRqUbQcxqmVLpWvLNMqY0w==
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMB9ZbRqUbQcxqmVQs2iANtSZ/QzsTig=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMB9ZbRqUbQcxqmVXpWbLNMqY0w==
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMB9ZbRqUbR0xqHpHpXCQMcGVoACvSUWNhg==
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUbxw/vm9b+GeIM6c=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUbBompyBBu2Dl
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUago4uW9QoiqGOsP8
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUaxc9vSBBu2Dl
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUZgYwrCBBu2Dl
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUZgA5rCBBu2Dl
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUex8wqHpH+GeIM6c=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUeR09vWtSpGuGecSRt28=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBVdai2oZgo3omBHoiqGOsP8
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBVdai2vYRg6pWFDsm2WOImfvguB
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBVdai2saxsirHxRv2uLecSRt28=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBVdai2qfgZ6qmNG1g==
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBNdcgKUewYx521PsgQ=
::fBE1pAF6MU+EWH3eyGY1OxBAQxS+GW+9A7kZ+/vHahpIJ6fV0xnH/WcNXmlypTfWb6Az/VjgUaG5HTfWMBZZdxyUbBomp1Fq+GeIM6c=
::YAwzoRdxOk+EWAjk
::fBw5plQjdCuDJH2B50kkJwtoaQCFOWe/FaYgxu3szOWVp3EzUfUPaoDR37eaHNUA71f3Sb8u2XRmi8MDHg9bawaXexw2q3tQuGGXec6fvG8=
::YAwzuBVtJxjWCl3EqQJgSA==
::ZR4luwNxJguZRRnk
::Yhs/ulQjdF+5
::cxAkpRVqdFKZSDk=
::cBs/ulQjdF+5
::ZR41oxFsdFKZSDk=
::eBoioBt6dFKZSDk=
::cRo6pxp7LAbNWATEpSI=
::egkzugNsPRvcWATEpSI=
::dAsiuh18IRvcCxnZtBJQ
::cRYluBh/LU+EWAnk
::YxY4rhs+aU+IeA==
::cxY6rQJ7JhzQF1fEqQJkZkMaHErSXA==
::ZQ05rAF9IBncCkqN+0xwdVsAAlzMbCXqZg==
::ZQ05rAF9IAHYFVzEqQIVLBxRQAGRL+5KyTD2IG8AF29vdMnAqGfovQo+DdQ=
::eg0/rx1wNQPfEVWB+kM9LVsJDGQ=
::fBEirQZwNQPfEVWB+kM9LVsJDGQ=
::cRolqwZ3JBvQF1fEqQIVLBxRQAGRL+5KyTD2IG8AF29vdMnAqGfovQo+DdQ=
::dhA7uBVwLU+EWHqK+yI=
::YQ03rBFzNR3SWATE0UY3LRdRXxfi
::dhAmsQZ3MwfNWATE0UY3LRdRXxfCCG67C/U95OS7/eOAqlkOFNA6a4rJzLGKQA==
::ZQ0/vhVqMQ3MEVWAtB9wSA==
::Zg8zqx1/OA3MEVWAtB9wSA==
::dhA7pRFwIByZRRnk
::Zh4grVQjdCuDJH2B50kkJwtoaQCFOWe/FaYgbRg0agBPJbbl0Qrp/FInX2NLpQXE1sAMoxLwKv+qV07mxJyjhlyudgpU
::YB416Ek+ZW8=
::
::
::978f952a14a936cc963da21a135fa983
@echo off
color 3f
::初始化操作
set burnername_current=启动盘制作工具_Beta_4.8.7z
cd /d "%~dp0"

::初始化日志
if exist .\Log_backup.txt del /f /q .\Log_backup.txt >nul
ren .\Log.txt Log_backup.txt
echo %date% >>.\Log.txt
echo %time% 启动盘制作工具-main_home-制作工具版本：%burnername_current%，系统版本： >>.\Log.txt

::报告系统版本号
REG QUERY "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion" /v ProductName >>.\Log.txt
cls

::检查是否需要版本间清理缓存
if exist .\Alpha.txt (
    if exist .\core\CleanChecker.txt del /f /q .\core\CleanChecker.txt
    del /f /q .\Alpha.txt
)
if exist .\core\CleanChecker.txt set /p burnername_previous=<.\core\CleanChecker.txt
if exist .\core\CleanChecker.txt (
    echo %time% 启动盘制作工具-main_home-启动，读取CleanCheck：%burnername_previous% >>.\Log.txt
    if "%burnername_current%" == "%burnername_previous%" goto skipClean
    echo %time% 启动盘制作工具-main_home-检测到版本不同，准备Clean >>.\Log.txt
    echo %burnername_current%>CleanChecker.txt
    start /min 辅助工具.bat
    exit
)
if not exist .\core\CleanChecker.txt (
    echo %burnername_current%>CleanChecker.txt
    echo %time% 启动盘制作工具-main_home-启动，初次运行，开始CleanCheck >>.\Log.txt
    start /min 辅助工具.bat
    exit
)
:skipClean
echo %time% 启动盘制作工具-main_home-CleanCheck结束 >>.\Log.txt
::生成并执行clean脚本
if not exist help_clean.cmd copy /y .\main_exit.cmd .\help_clean.cmd
start /min /wait help_clean.cmd

if not exist .\制作启动盘.exe goto skipHideSelf
attrib +s +a +h +r *.cmd
:skipHideSelf

::检查是否需要捡拾离线镜像
if exist Edgeless* echo %time% 启动盘制作工具-main_home-检测到Edgeless开头的文件，开始检查是否需要捡拾离线镜像 >>.\Log.txt
if exist Edgeless* title 正在确认自定义镜像
::if exist Edgeless* core\EasyDown\EasyDown.exe -Down("http://s.edgeless.top/?token=version","version_ol.txt","%~dp0core")
if exist Edgeless* call net_api version version_ol.txt a
if not exist core\version_ol.txt echo %time% 启动盘制作工具-main_home-校验捡拾时获取在线版本失败或无需校验，继续 >>.\Log.txt
if not exist core\version_ol.txt goto selfISO
if exist Edgeless* set /p version_ol=<"%~dp0core\version_ol.txt"
if exist Edgeless* (
    echo %time% 启动盘制作工具-main_home-校验捡拾获得的在线镜像文件名：%version_ol% >>.\Log.txt
    if not defined version_ol echo %time% 启动盘制作工具-main_home-校验捡拾的version_ol未定义，跳过校验捡拾 >>.\Log.txt
    if not defined version_ol goto skipPick
    if not exist ".\%version_ol:~0,9%%version_ol:~9,5%%version_ol:~20,5%.iso" goto selfISO
    echo %time% 启动盘制作工具-main_home-校验通过，开始捡拾 >>.\Log.txt
    if exist .\core\Edgeless_backup.iso del /f /q .\core\Edgeless_backup.iso >nul
    if exist .\core\Edgeless_backup.iso echo %time% 启动盘制作工具-main_home-删除Edgeless_backup.iso失败 >>.\Log.txt
    if exist core\Edgeless.iso ren core\Edgeless.iso Edgeless_backup.iso
    if exist .\core\Edgeless.iso echo %time% 启动盘制作工具-main_home-备份Edgeless.iso失败 >>.\Log.txt
    move /y ".\%version_ol:~0,9%%version_ol:~9,5%%version_ol:~20,5%.iso" ".\core\Edgeless.iso"
    if not exist .\core\Edgeless.iso echo %time% 启动盘制作工具-main_home-移动为Edgeless.iso失败 >>.\Log.txt
    ren core\version_ol.txt version_iso.txt
    if not exist .\core\version_iso.txt echo %time% 启动盘制作工具-main_home-转换ol版本信息为iso失败 >>.\Log.txt
)
:skipPick
echo %time% 启动盘制作工具-main_home-跳出校验捡拾 >>.\Log.txt

::确认是否需要烧录自定义镜像
:selfISO
echo %time% 启动盘制作工具-main_home-确认是否需要烧录自定义镜像，isolist如下 >>.\Log.txt
dir /b *.iso >isolist.txt
type isolist.txt >>.\Log.txt
set /p key=<isolist.txt
echo %time% 启动盘制作工具-main_home-获得的自定义镜像为：%key% >>.\Log.txt
if not defined key goto skipSelfISO

    if %key%==Edgeless.iso goto homeHelp
    :ctnHelp
    cls
    title 烧录自定义镜像
    color 3f
    cls
    echo.
    echo.
    echo           被选择的ISO镜像名称：%key%
    echo.
    echo.
    echo ====================================================================
    echo 注意：当前模式下只能制作包含一个FAT32分区的启动盘，不能放4GB以上大文件
    echo 原因是此镜像不是最新版本的Edgeless或程序无法连接到Edgeless服务器
    echo ====================================================================
    pause
    
    echo "%~dp0%key%" >burn_target.txt
    echo 0 >burn_check.txt
    call main_burn.cmd
    call main_exit.cmd
    exit

:skipSelfISO
echo %time% 启动盘制作工具-main_home-自定义镜像名字未定义，继续 >>.\Log.txt
if exist isolist.txt del /f /q isolist.txt >nul


::OTA
echo %time% 启动盘制作工具-main_home-开始判断OTA >>.\Log.txt
if exist X:\Users\StartOTA.txt (
    set ota=1
    echo %time% 启动盘制作工具-main_home-开始OTA >>.\Log.txt
    goto checkusb
)
if exist "X:\Program Files\version.txt" (
    echo %time% 启动盘制作工具-main_home-打开OTA目录选择界面 >>.\Log.txt
    if not exist X:\Users\StartOTA.txt pecmd exec core\OTA\GUI.wcs
    call main_exit.cmd
    exit
)



::检查自身更新
title 正在检查制作工具更新
color 3f
echo %time% 启动盘制作工具-main_home-检查自身更新 >>.\Log.txt
cls
::core\EasyDown\EasyDown.exe -Down("http://s.edgeless.top/?token=burnername","burnername.txt","%~dp0core")
call net_api burnername burnername.txt a
if not exist core\burnername.txt echo %time% 启动盘制作工具-main_home-burnername获取失败，跳过自更新 >>.\Log.txt
if not exist core\burnername.txt goto endSelfCheck
set /p burnername_ol=<core\burnername.txt
echo %time% 启动盘制作工具-main_home-burnername_ol：%burnername_ol% >>.\Log.txt
if not defined burnername_ol echo %time% 启动盘制作工具-main_home-burnername_ol未定义，跳过自更新 >>.\Log.txt
if not defined burnername_ol goto endSelfCheck
if %burnername_ol%==%burnername_current% echo %time% 启动盘制作工具-main_home-制作工具已是最新版本：%burnername_ol% >>.\Log.txt
if %burnername_ol%==%burnername_current% goto endSelfCheck
echo %time% 启动盘制作工具-main_home-制作工具有更新，当前：%burnername_current%，最新：%burnername_ol% >>.\Log.txt
title 启动盘制作工具有更新！
cls
echo.
echo  注意：当前存在启动盘制作工具的更新版本
echo.
echo    最新版本：%burnername_ol%
echo    当前版本：%burnername_current%
echo.
echo 继续使用当前版本可能无法实现最新特性，请前往https://down.edgeless.top下载更新，或者按任意键继续使用当前版本
echo.
echo.
pause
echo %time% 启动盘制作工具-main_home-用户忽略制作工具更新 >>.\Log.txt
:endSelfCheck


:checkusb
echo %time% 启动盘制作工具-main_home-开始搜索U盘 >>.\Log.txt
cls
for %%1 in (Z Y X W V T S R Q P O N M L K J I H G F E D C U) do if exist %%1:\Edgeless\version.txt echo %%1>Upath.txt
if exist Upath.txt set /p Upath=<Upath.txt
echo %time% 启动盘制作工具-main_home-使用%Upath%作为Edgeless盘符 >>.\Log.txt
if exist %Upath%:\Edgeless\version.txt set /p version_usb=<%Upath%:\Edgeless\version.txt
echo %time% 启动盘制作工具-main_home-%Upath%盘上的Edgeless版本号：%version_usb% >>.\Log.txt
if not defined version_usb if defined ota (
    echo %time% 启动盘制作工具-main_home-未检测到Edgeless启动盘（OTA） >>.\Log.txt
    title 未检测到Edgeless启动盘
    cls
    echo.
    echo.
    echo.
    echo     未检测到合法的Edgeless启动盘
    echo  请插入您的Edgeless启动盘后按下任意键
    echo.
    echo.
    echo.
    pause
    echo %time% 启动盘制作工具-main_home-用户选择重试 >>.\Log.txt
    goto checkusb
)
if defined version_usb (
    echo %time% 启动盘制作工具-main_home-有效的启动盘，开始准备OTA >>.\Log.txt
    call net_getversion.cmd
    call dash_checkusb.cmd
    call main_exit.cmd
    exit
)






::无自定义镜像且无可升级U盘
echo %time% 启动盘制作工具-main_home-无自定义镜像且无可升级U盘 >>.\Log.txt
cd /d "%~dp0"
call dash_checkiso.cmd
call main_askway.cmd
call main_exit.cmd
exit


:homeHelp
echo %time% 启动盘制作工具-main_home-提示复制方法有问题 >>.\Log.txt
cls
title 不想重复下载镜像？
echo.
echo 我们注意到您将旧版程序core文件夹内的镜像复制了过来，但是您的复制方式有一些问题
echo 请将Edgeless.iso和version_iso.txt同时放到本目录的core文件夹内然后重启程序
echo.
echo 或者按下任意键将这个镜像作为自定义镜像写入
echo.
pause
goto ctnHelp